{% extends "dashboard/base.html" %}
{% load static %}
{% block content %}

<div class="container my-5">
    <h1 class="text-center mb-4">Monitor Cardíaco en Tiempo Real</h1>

    <!-- BLOQUE DEL CORAZÓN -->
    <div class="text-center mb-4">

        <div style="position: relative; display: inline-block;">
            
            <!-- Imagen del corazón -->
            <img src="{% static 'dashboard/cora.gif' %}" 
                 alt="corazón" 
                 style="width: 120px;">

            <!-- Número encima -->
            <span id="bpm-actual"
                  style="
                      position: absolute;
                      top: 50%;
                      left: 50%;
                      transform: translate(-50%, -55%);
                      font-size: 48px;
                      font-weight: bold;
                      color: black;
                      text-shadow: 0 0 8px white;
                  ">
                --
            </span>
        </div>

        <!-- Texto BPM debajo -->
        <div style="font-size: 1.8rem; color: black; margin-top: 8px;">
            BPM
        </div>

    </div>

    <!-- AQUI VA LA GRAFICA -->
    <canvas id="ecgCanvas" width="900" height="360"
            style="background:black; width:100%; border:1px solid #333; position:relative;">
    </canvas>
</div>

<!-- SCRIPT ECG -->
<script>
let bpmActual = 70;
let refreshInterval = 2000;

const canvas = document.getElementById("ecgCanvas");
const ctx = canvas.getContext("2d");

let x = 0;
let baseline = canvas.height * 0.60;  // centrado

// Amplitud aumentada estilo monitor
const AMP = 3.2;

// Imagen de cuadrícula en la esquina superior izquierda
const gridImg = new Image();
gridImg.src = "{% static 'dashboard/grid.png' %}";  // <-- PON AQUÍ TU IMAGEN
let gridLoaded = false;
gridImg.onload = () => gridLoaded = true;


// Forma ECG
function ecgWave(t) {

    if (t > 0.10 && t < 0.18) return AMP * (-10 * Math.sin((t - 0.10) * Math.PI / 0.08));
    if (t > 0.20 && t < 0.21) return AMP * (+15);
    if (t > 0.21 && t < 0.22) return AMP * (-55);
    if (t > 0.22 && t < 0.25) return AMP * (+25);
    if (t > 0.35 && t < 0.55) return AMP * (-18 * Math.sin((t - 0.35) * Math.PI / 0.20));

    return 0;
}


// Dibujo ECG
function drawECG() {

    // Fondo negro
    ctx.fillStyle = "black";
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // Imagen grid en esquina superior izquierda (como pediste)
    if (gridLoaded) {
        ctx.drawImage(gridImg, 0, 0, 180, 120);
    }

    // Estilo línea ECG
    ctx.strokeStyle = "#00FFE3";
    ctx.lineWidth = 2;
    ctx.beginPath();

    for (let i = 0; i < canvas.width; i++) {
        let t = ((i + x) % 180) / 180; // beatWidth = 180
        let y = baseline + ecgWave(t);

        if (i === 0) ctx.moveTo(i, y);
        else ctx.lineTo(i, y);
    }

    ctx.stroke();

    // Movimiento del trazo
    x += 2.5;

    requestAnimationFrame(drawECG);
}


// Actualizar BPM
function actualizarBPM() {
    fetch(window.location.href, {
        headers: {"X-Requested-With": "XMLHttpRequest"}
    })
    .then(r => r.json())
    .then(data => {
        bpmActual = data.bpm;
        document.getElementById("bpm-actual").textContent = bpmActual;
    });
}


// Inicio
drawECG();
actualizarBPM();
setInterval(actualizarBPM, refreshInterval);
</script>

{% endblock %}
